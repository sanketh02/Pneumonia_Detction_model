# -*- coding: utf-8 -*-
"""Pneumonia_prediction_model.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/13NPR95qsMRchpHKqssEktWWvB70MEEUj
"""

import os

os.environ["KAGGLE_USERNAME"] = 'sanket09'
os.environ['KAGGLE_KEY'] = "KGAT_01e83d6eec6c335e183daecd60d35848"

#!/bin/bash
!kaggle datasets download paultimothymooney/chest-xray-pneumonia

!unzip chest-xray-pneumonia.zip

!ls

import os
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.image as mpimg
import cv2 #to perform image operation
from google.colab.patches import cv2_imshow # create new window and displays image in that window
from PIL import Image # image processing library
from sklearn.model_selection import train_test_split

normal_test_file = os.listdir('/content/chest_xray/test/NORMAL')
normal_train_file = os.listdir('/content/chest_xray/train/NORMAL')
normal_val_file = os.listdir('/content/chest_xray/val/NORMAL')

pneumonia_test_file = os.listdir('/content/chest_xray/test/PNEUMONIA')
pneumonia_train_file = os.listdir('/content/chest_xray/train/PNEUMONIA')
pneumonia_val_file = os.listdir('/content/chest_xray/val/PNEUMONIA')

print(normal_test_file[:5])
print(pneumonia_test_file[:5])

print("Number of Normal case :",len(normal_test_file) + len(normal_train_file) + len(normal_val_file))

print("Number of pneumonia file :",len(pneumonia_test_file) + len(pneumonia_train_file) + len(pneumonia_val_file))

"""**Creating Labels for two classes**

0 -> Normal

1 -> pneumonia

"""

normal_labels = [0]*1583
pneumonia_labels = [1]*4273

normal_labels[:10]

pneumonia_labels[:10]

labels = normal_labels + pneumonia_labels

"""Displaying the Images"""

# chest x-ray of normal person
img = mpimg.imread('/content/chest_xray/test/NORMAL/IM-0039-0001.jpeg')
plt.imshow(img)
plt.show()

# chest x-ray of person suffering from pneumonia
img2 = mpimg.imread('/content/chest_xray/test/PNEUMONIA/person85_bacteria_417.jpeg')
plt.imshow(img2)
plt.show()

"""**Image Processing Step**

1. Resize image
2. Convert image into numpy array
"""

data = []

normal_test_file_path = '/content/chest_xray/test/NORMAL/'

for img_file in normal_test_file:
  image = Image.open(normal_test_file_path + img_file)
  image = image.resize((128,128))
  image = image.convert("RGB")
  image = np.array(image)
  data.append(image)

normal_train_file_path = '/content/chest_xray/train/NORMAL/'

for img_file in normal_train_file:
  image = Image.open(normal_train_file_path + img_file)
  image = image.resize((128,128))
  image = image.convert("RGB")
  image = np.array(image)
  data.append(image)

normal_val_file_path = '/content/chest_xray/val/NORMAL/'

for img_file in normal_val_file:
  image = Image.open(normal_val_file_path + img_file)
  image = image.resize((128,128))
  image = image.convert("RGB")
  image = np.array(image)
  data.append(image)

pneumonia_test_file_path = '/content/chest_xray/test/PNEUMONIA/'

for img_file in pneumonia_test_file:
  image = Image.open(pneumonia_test_file_path + img_file)
  image = image.resize((128,128))
  image = image.convert("RGB")
  image = np.array(image)
  data.append(image)


pneumonia_train_file_path = '/content/chest_xray/train/PNEUMONIA/'

for img_file in pneumonia_train_file:
  image = Image.open(pneumonia_train_file_path + img_file)
  image = image.resize((128,128))
  image = image.convert("RGB")
  image = np.array(image)
  data.append(image)


pneumonia_val_file_path = '/content/chest_xray/val/PNEUMONIA/'

for img_file in pneumonia_val_file:
  image = Image.open(pneumonia_val_file_path + img_file)
  image = image.resize((128,128))
  image = image.convert("RGB")
  image = np.array(image)
  data.append(image)

if len(data) == len(labels):
  print("Number of images matches with number of labels")

data[18]

# Converting image list and labels list into numpy array

X = np.array(data)
Y = np.array(labels)

print(X.shape)
print(Y.shape)

"""**Train Test Split**"""

x_train, x_test, y_train, y_test = train_test_split(X, Y, test_size=0.2,random_state=2)

print(X.shape, x_train.shape, x_test.shape)

# Scalling

x_train_scl = x_train/255
x_test_scl = x_test/255

x_train_scl[2]

"""**Model Building**"""

import tensorflow as tf
from tensorflow.keras import layers, models

# Define input shape
input_shape = (128, 128, 3)

model = models.Sequential()

# ------------------- Conv Block 1 -------------------
model.add(layers.Conv2D(32, (3,3), padding='valid', input_shape=input_shape))
model.add(layers.BatchNormalization())
model.add(layers.Activation('relu'))
model.add(layers.MaxPooling2D((2,2)))

# ------------------- Conv Block 2 -------------------
model.add(layers.Conv2D(64, (3,3), padding='valid'))
model.add(layers.BatchNormalization())
model.add(layers.Activation('relu'))
model.add(layers.MaxPooling2D((2,2)))

# ------------------- Conv Block 3 -------------------
model.add(layers.Conv2D(128, (3,3), padding='valid'))
model.add(layers.BatchNormalization())
model.add(layers.Activation('relu'))
model.add(layers.MaxPooling2D((2,2)))

# ------------------- Conv Block 4 -------------------
model.add(layers.Conv2D(256, (3,3), padding='valid'))
model.add(layers.BatchNormalization())
model.add(layers.Activation('relu'))
model.add(layers.MaxPooling2D((2,2)))

# ------------------- Flatten -------------------
model.add(layers.Flatten())

# ------------------- Dense Layers -------------------
model.add(layers.Dense(512, activation='relu'))
model.add(layers.BatchNormalization())
model.add(layers.Dropout(0.5))

model.add(layers.Dense(128, activation='relu'))
model.add(layers.Dropout(0.4))

model.add(layers.Dense(64, activation='relu'))
model.add(layers.Dropout(0.3))

# ------------------- Output Layer -------------------
model.add(layers.Dense(2, activation='sigmoid'))

# ------------------- Compile -------------------
model.compile(
    optimizer=tf.keras.optimizers.Adam(learning_rate=0.0001),
    loss='sparse_categorical_crossentropy',
    metrics=['accuracy']
)

model.summary()

history = model.fit(
    x_train_scl,
    y_train,
    epochs=5,
    validation_split=0.1
)

# Model evaluation

test_loss, test_acc = model.evaluate(x_test_scl, y_test)
print("Test Accuracy :", test_acc)

# plotting loss vs accuarcy

h = history

# Loss
plt.plot(h.history['loss'],label='train_loss')
plt.plot(h.history['val_loss'],label='val_loss')

# Accuracy
plt.plot(h.history['accuracy'],label='train_accuracy')
plt.plot(h.history['val_accuracy'],label='val_accuracy')
plt.legend()
plt.show()

model.save('Pneumonia_detection_model.h5')

input_image_path = input("Enter the path of image")

imput_image = cv2.imread(input_image_path)
cv2_imshow(imput_image)

input_image = cv2.resize(imput_image,(128,128))
input_image_scaled = input_image/255
input_image_reshaped = np.reshape(input_image_scaled,[1,128,128,3])

prediction = model.predict(input_image_reshaped)

print(prediction)

input_predict_label = np.argmax(prediction)

if input_predict_label == 1:
  print("The person is suffering from Pneumonia")
else:
  print("The person is Normal")

